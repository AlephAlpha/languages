stages: [init, build]

rules:
  - if: $CI_COMMIT_BRANCH == "main"

# template used for building docker images
.base:
  stage: build
  tags: [ato_buildbox]

init:
  extends: .base
  stage: init
  script:
    # this ensures no stale cache is used - and we have enough disk space for a full build
    - podman system prune -af
    # we can't use the default $CI_REGISTRY_USER/$CI_REGISTRY_PASSWORD because they're per-job
    # and these credentials need to be shared for the entire pipeline
    - podman login "$CI_REGISTRY" -u "$DEPLOYTOKEN_USER" --password-stdin <<<"$DEPLOYTOKEN_PASSWORD"

include:
  # generated by gen_ci_config.py
  - local: .images.gitlab-ci.yml
